---
- name: Ensure that the sudo package is installed
  tags: sudo
  become: true
  yum:
    name: sudo
    state: present
  register: sudo_yum

- block:
    - name: Applying sudoers configurations
      template:
        src: sudoers.j2
        dest: /etc/sudoers
        owner: root
        group: root
        mode: 0440

    - name: Applying sudoers.d configurations
      template:
        src: sudoers_d.j2
        dest: "/etc/sudoers.d/{{ item.file }}"
        owner: root
        group: root
        mode: 0440
      with_items: "{{ sudoers_d }}"
      when:
        - item.commands is defined
        - item.file is defined
        - item.ugid is defined
  tags: sudo
  become: true
  when: sudo_yum|success
...
